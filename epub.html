<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>EPUB Translator</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container py-5">

<h3>EPUB 中英對照翻譯</h3>

<input type="file" id="file" accept=".epub" class="form-control mb-3">

<button class="btn btn-primary" onclick="upload()">開始翻譯</button>

<div class="progress mt-4">
  <div id="bar" class="progress-bar" style="width:0%">0%</div>
</div>
<div id="eta" class="mt-2 text-muted"></div>

<script>
async function upload() {
  const f = document.getElementById('file').files[0];
  if (!f) return alert('請選 EPUB');

  const fd = new FormData();
  fd.append('epub', f);

  const res = await fetch('https://newsbeiter.onrender.com/upload-epub', {
    method: 'POST',
    body: fd
  });

  const reader = res.body.getReader();
  const dec = new TextDecoder();
  let buf = '';

  while (true) {
    const { done, value } = await reader.read();
    if (done) break;
    buf += dec.decode(value, { stream: true });

    for (const line of buf.split('\n')) {
      if (!line.startsWith('data:')) continue;
      const msg = JSON.parse(line.slice(5));
      if (msg.progress !== undefined) {
        bar.style.width = msg.progress + '%';
        bar.innerText = msg.progress + '%';
        eta.innerText = msg.eta || '';
      }
      if (msg.done) {
        window.location = msg.download;
      }
    }
    buf = '';
  }
}
</script>
</body>
</html>
