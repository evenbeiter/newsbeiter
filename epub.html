<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>EPUB 中英對照</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
.translation { color: #0b5ed7; font-style: italic; margin-top: .25rem; margin-bottom: .75rem; }
.small-muted { font-size: .9rem; color: #6c757d; }
</style>
</head>
<body class="bg-light">
<div class="container py-4">
  <h1 class="mb-3">EPUB 中英對照</h1>
  <div class="card mb-3">
    <div class="card-body">
      <div class="mb-3">
        <label class="form-label">上傳 EPUB 檔案</label>
        <input id="epubFile" type="file" accept=".epub" class="form-control"/>
      </div>
      <div class="mb-3 row">
        <div class="col-md-6">
          <label class="form-label">後端翻譯 API</label>
          <input id="backendUrl" class="form-control" value="http://localhost:3000/translate-epub-html"/>
        </div>
        <div class="col-md-3">
          <label class="form-label">source</label>
          <input id="source" class="form-control" value="en"/>
        </div>
        <div class="col-md-3">
          <label class="form-label">target</label>
          <input id="target" class="form-control" value="zh-TW"/>
        </div>
      </div>
      <div class="mb-3">
        <button id="startBtn" class="btn btn-primary">開始處理 EPUB</button>
      </div>
      <div id="log" class="border rounded p-2 bg-white" style="max-height:260px; overflow:auto;">
        <div class="small-muted">日誌</div>
      </div>
      <div id="downloadArea" class="mt-3"></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script>
const $ = id => document.getElementById(id);
const logEl = $('log');
function log(msg){ const d=document.createElement('div'); d.className='mb-1'; d.textContent=msg; logEl.appendChild(d); logEl.scrollTop=logEl.scrollHeight; }

async function findOpfPath(zip) {
  const p='META-INF/container.xml';
  if(!zip.file(p)) throw new Error('找不到 container.xml');
  const txt = await zip.file(p).async('string');
  const doc = new DOMParser().parseFromString(txt,'application/xml');
  const rf = doc.querySelector('rootfile');
  if(!rf) throw new Error('container.xml 解析失敗');
  return rf.getAttribute('full-path');
}

function resolveHref(opfFolder, href){
  if(!opfFolder) return href;
  return opfFolder+(opfFolder.endsWith('/')?'':'/')+href;
}

$('startBtn').addEventListener('click', async () => {
  logEl.innerHTML='<div class="small-muted">開始處理...</div>';
  const fileInp=$('epubFile');
  if(!fileInp.files.length){ log('請選 EPUB'); return; }
  const file = fileInp.files[0];
  //const backendUrl = $('backendUrl').value.trim();
  const backendUrl = 'https://newsbeiter.onrender.com/translate/epub';
  const source = $('source').value.trim();
  const target = $('target').value.trim();

  log(`讀取 ${file.name}...`);
  const arrayBuffer = await file.arrayBuffer();
  const zip = await JSZip.loadAsync(arrayBuffer);

  let opfPath;
  try { opfPath = await findOpfPath(zip); log('OPF: '+opfPath); } 
  catch(e){ log('找 OPF 失敗: '+e.message); return; }

  const opfText = await zip.file(opfPath).async('string');
  const opfDoc = new DOMParser().parseFromString(opfText,'application/xml');
  const opfFolder = opfPath.includes('/') ? opfPath.substring(0, opfPath.lastIndexOf('/')) : '';

  const manifest = {};
  opfDoc.querySelectorAll('manifest > item').forEach(it => manifest[it.getAttribute('id')]={href:it.getAttribute('href'), type:it.getAttribute('media-type')});
  const spine = [...opfDoc.querySelectorAll('spine > itemref')].map(ir=>ir.getAttribute('idref'));
  const xhtmlItems = spine.map(idref=>manifest[idref]).filter(it=>it && (it.type.includes('xhtml')||it.href.endsWith('.xhtml')||it.href.endsWith('.html')));

  log(`找到 ${xhtmlItems.length} 章節可處理`);

  for(const xi of xhtmlItems){
    const resolved = resolveHref(opfFolder, xi.href);
    const fileEntry = zip.file(resolved)||zip.file(xi.href);
    if(!fileEntry){ log(`找不到 ${resolved}, 跳過`); continue; }
    const html = await fileEntry.async('string');

    log(`翻譯 ${xi.href} ...`);
    try{
      const resp = await fetch(backendUrl,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ html, source, target })
      });
      if(!resp.ok){ const t=await resp.text(); throw new Error(`後端 ${resp.status}: ${t}`); }
      const j = await resp.json();
      if(!j.html) throw new Error('後端回傳格式錯誤');

      zip.file(resolved, j.html);
    }catch(e){ log(`翻譯失敗: ${e.message}`); }
  }

  log('打包新 EPUB...');
  const newBlob = await zip.generateAsync({ type:'blob', compression:'DEFLATE' });
  const downloadName = file.name.replace(/\.epub$/i,'')+' (en-zh).epub';
  const a=document.createElement('a');
  a.href=URL.createObjectURL(newBlob);
  a.download=downloadName;
  a.className='btn btn-success';
  a.textContent='下載 '+downloadName;
  $('downloadArea').innerHTML='';
  $('downloadArea').appendChild(a);
  log('完成！請點下載。');
});
</script>
</body>
</html>
