<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>My TiddlyWiki</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #tiddler-list { width: 25%; float: left; border-right: 1px solid #ccc; padding-right: 10px; }
    #editor { width: 70%; float: left; margin-left: 20px; }
    li { cursor: pointer; margin-bottom: 5px; }
    textarea { width: 100%; height: 300px; }
    button { margin-top: 10px; }
    .selected { font-weight: bold; }
  </style>
</head>
<body>
  <h1>My TiddlyWiki</h1>
  <div id="tiddler-list">
    <h3>筆記列表</h3>
    <ul id="list"></ul>
    <button id="new">新增筆記</button>
  </div>
  <div id="editor">
    <h3 id="editor-title">請選擇或新增筆記</h3>
    <textarea id="content"></textarea>
    <br>
    <button id="save">保存</button>
    <button id="delete">刪除</button>
  </div>

  <script>
    const API_URL = 'https://newsbeiter.onrender.com/tiddlers'; // 改成你的 Render TiddlyServer URL

    let tiddlers = [];
    let current = null;

    const listEl = document.getElementById('list');
    const titleEl = document.getElementById('editor-title');
    const contentEl = document.getElementById('content');

    function refreshList() {
      listEl.innerHTML = '';
      tiddlers.forEach(t => {
        const li = document.createElement('li');
        li.textContent = t.name;
        li.className = (current && current.name === t.name) ? 'selected' : '';
        li.onclick = () => selectTiddler(t.name);
        listEl.appendChild(li);
      });
    }

    function selectTiddler(name) {
      current = tiddlers.find(t => t.name === name);
      titleEl.textContent = current.name;
      contentEl.value = current.content;
      refreshList();
    }

    async function loadTiddlers() {
      const res = await fetch(API_URL);
      tiddlers = await res.json();
      if (tiddlers.length > 0 && !current) selectTiddler(tiddlers[0].name);
      refreshList();
    }

    async function saveTiddler() {
      if (!current) return alert('請先選擇或新增筆記');
      current.content = contentEl.value;
      await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: current.name, content: current.content })
      });
      alert('保存成功！');
      loadTiddlers();
    }

    async function deleteTiddler() {
      if (!current) return alert('請先選擇筆記');
      if (!confirm('確定刪除？')) return;
      await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: current.name, content: '' })
      });
      current = null;
      contentEl.value = '';
      titleEl.textContent = '請選擇或新增筆記';
      loadTiddlers();
    }

    function newTiddler() {
      const name = prompt('輸入新筆記名稱：');
      if (!name) return;
      current = { name: name + '.tid', content: '' };
      tiddlers.push(current);
      refreshList();
      selectTiddler(current.name);
    }

    document.getElementById('save').onclick = saveTiddler;
    document.getElementById('delete').onclick = deleteTiddler;
    document.getElementById('new').onclick = newTiddler;

    loadTiddlers();
  </script>
</body>
</html>
