<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EPUB 中英對照</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .translation { color: #0b5ed7; font-style: italic; margin-top: .25rem; margin-bottom: .75rem; }
    .small-muted { font-size: .9rem; color: #6c757d; }
    pre { white-space: pre-wrap; word-break: break-word; }
  </style>
</head>
<body class="bg-light">
<div class="container py-4">
  <h1 class="mb-3">EPUB 中英對照</h1>

  <div class="card mb-3">
    <div class="card-body">
      <div class="mb-3">
        <label class="form-label">上傳 EPUB 檔案</label>
        <input id="epubFile" type="file" accept=".epub" class="form-control" />
      </div>

      <div class="mb-3 row">
        <div class="col-md-6">
          <label class="form-label">後端翻譯 API</label>
          <input id="backendUrl" class="form-control" value="http://localhost:3000/translate-epub-html" />
        </div>
        <div class="col-md-3">
          <label class="form-label">source</label>
          <input id="source" class="form-control" value="en" />
        </div>
        <div class="col-md-3">
          <label class="form-label">target</label>
          <input id="target" class="form-control" value="zh-TW" />
        </div>
      </div>

      <div class="mb-3">
        <button id="startBtn" class="btn btn-primary">開始處理（上傳 → 翻譯 → 下載）</button>
      </div>

      <div class="progress mb-2" style="height:20px;">
        <div id="progressBar" class="progress-bar" role="progressbar" style="width:0%">0%</div>
      </div>

      <div id="eta" class="small-muted mb-2"></div>

      <div id="log" class="border rounded p-2 bg-white" style="max-height:260px; overflow:auto;">
        <div class="small-muted">日誌</div>
      </div>

      <div id="downloadArea" class="mt-3"></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script>
const $ = id => document.getElementById(id);
const logEl = $('log');
const progressBar = $('progressBar');
const etaEl = $('eta');

function log(msg){
  const d = document.createElement('div');
  d.className = 'mb-1';
  d.textContent = msg;
  logEl.appendChild(d);
  logEl.scrollTop = logEl.scrollHeight;
}

function updateProgress(current,total,startTime){
  const pct = Math.floor(current/total*100);
  progressBar.style.width = pct+'%';
  progressBar.textContent = pct+'%';
  const elapsed = (Date.now() - startTime)/1000;
  const eta = elapsed/current*(total-current);
  etaEl.textContent = `進度: ${current}/${total}，預估剩餘 ${Math.ceil(eta)} 秒`;
}

// simple in-memory cache for same paragraphs
const translationCache = {};

async function translateHtml(html, backendUrl, source, target){
  if(translationCache[html]) return translationCache[html];
  const resp = await fetch(backendUrl,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({html, source, target})
  });
  if(!resp.ok) throw new Error(`後端錯誤 ${resp.status}`);
  const j = await resp.json();
  if(!j.html) throw new Error('後端回傳格式錯誤');
  translationCache[html] = j.html;
  return j.html;
}

$('startBtn').addEventListener('click', async ()=>{
  const fileInp = $('epubFile');
  if(!fileInp.files || !fileInp.files.length){ log('請選 EPUB'); return; }
  const file = fileInp.files[0];
  //const backendUrl = $('backendUrl').value.trim();
const backendUrl = 'https://newsbeiter.onrender.com/translate/epub';
  const source = $('source').value.trim();
  const target = $('target').value.trim();

  log(`讀取 EPUB: ${file.name} ...`);
  const arrayBuffer = await file.arrayBuffer();
  const zip = await JSZip.loadAsync(arrayBuffer);

  // 找 OPF
  const containerXml = await zip.file('META-INF/container.xml').async('string');
  const parser = new DOMParser();
  const containerDoc = parser.parseFromString(containerXml,'application/xml');
  const rootfile = containerDoc.querySelector('rootfile');
  if(!rootfile) { log('container.xml解析失敗'); return; }
  const opfPath = rootfile.getAttribute('full-path');
  const opfFolder = opfPath.includes('/')? opfPath.substring(0,opfPath.lastIndexOf('/')) : '';

  const opfText = await zip.file(opfPath).async('string');
  const opfDoc = parser.parseFromString(opfText,'application/xml');

  const manifest = {};
  for(const item of opfDoc.querySelectorAll('manifest > item')){
    manifest[item.getAttribute('id')] = {href:item.getAttribute('href'), type:item.getAttribute('media-type')};
  }
  const spine = [...opfDoc.querySelectorAll('spine > itemref')].map(ir=>ir.getAttribute('idref'));

  // 收集 XHTML/HTML 檔
  const htmlFiles = [];
  for(const idref of spine){
    const it = manifest[idref];
    if(!it) continue;
    const href = it.href;
    if(it.type?.includes('xhtml') || it.type?.includes('html') || href.endsWith('.xhtml') || href.endsWith('.html')){
      htmlFiles.push({idref, href});
    }
  }

  log(`找到 ${htmlFiles.length} 章節`);

  const startTime = Date.now();
  for(let i=0;i<htmlFiles.length;i++){
    const hf = htmlFiles[i];
    const resolved = opfFolder? opfFolder+'/'+hf.href : hf.href;
    const fileEntry = zip.file(resolved) || zip.file(hf.href);
    if(!fileEntry){ log(`找不到 ${resolved}`); continue; }
    const html = await fileEntry.async('string');
    log(`翻譯章節 ${i+1}/${htmlFiles.length}: ${hf.href}`);
    try{
      const translated = await translateHtml(html, backendUrl, source, target);
      zip.file(resolved, translated);
    }catch(e){
      log(`翻譯失敗: ${e.message}`);
    }
    updateProgress(i+1, htmlFiles.length, startTime);
  }

  // 生成新 EPUB
  log('生成新 EPUB...');
  const newBlob = await zip.generateAsync({type:'blob', compression:'DEFLATE'});
  const downloadName = file.name.replace(/\.epub$/i,'')+' (en-zh).epub';
  const a = document.createElement('a');
  a.href = URL.createObjectURL(newBlob);
  a.download = downloadName;
  a.className = 'btn btn-success';
  a.textContent = '下載 ' + downloadName;
  const area = $('downloadArea');
  area.innerHTML = '';
  area.appendChild(a);
  log('完成！請點下載。');
});
</script>
</body>
</html>