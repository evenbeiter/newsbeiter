<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EPUB 簡體 → 繁體（OpenCC）</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/opencc-js@1.0.5/dist/umd/opencc.min.js"></script>
  <style>
    .small-muted { font-size: .9rem; color: #6c757d; }
    pre { white-space: pre-wrap; word-break: break-word; }
  </style>
</head>
<body class="bg-light">
<div class="container py-4">
  <h1 class="mb-3">EPUB 簡體 → 繁體（OpenCC 單頁版）</h1>

  <div class="card mb-3">
    <div class="card-body">
      <div class="mb-3">
        <label class="form-label">上傳 EPUB 檔案</label>
        <input id="epubFile" type="file" accept=".epub" class="form-control" />
      </div>

      <div class="mb-3 row">
        <div class="col-md-4">
          <label class="form-label">轉換模式</label>
          <select id="profile" class="form-control">
            <option value="s2tw">簡 → 台灣繁體（s2tw）</option>
            <option value="s2twp">簡 → 台灣繁體＋詞彙優化（s2twp）</option>
          </select>
        </div>
        <div class="col-md-4 d-flex align-items-end">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="convertQuotes">
            <label class="form-check-label" for="convertQuotes">
              轉換中文引號（" → 「」、' → 『』）
            </label>
          </div>
        </div>
      </div>
      </div>

      <div class="mb-3">
        <button id="startBtn" class="btn btn-primary">開始處理（上傳 → 轉換 → 下載）</button>
      </div>

      <div class="progress mb-2" style="height:20px;">
        <div id="progressBar" class="progress-bar" role="progressbar" style="width:0%">0%</div>
      </div>

      <div id="eta" class="small-muted mb-2"></div>

      <div id="log" class="border rounded p-2 bg-white" style="max-height:260px; overflow:auto;">
        <div class="small-muted">日誌</div>
      </div>

      <div id="downloadArea" class="mt-3"></div>
    </div>
  </div>
</div>

<script>
const $ = id => document.getElementById(id);
const logEl = $('log');
const progressBar = $('progressBar');
const etaEl = $('eta');

function log(msg){
  const d = document.createElement('div');
  d.className = 'mb-1';
  d.textContent = msg;
  logEl.appendChild(d);
  logEl.scrollTop = logEl.scrollHeight;
}

function updateProgress(current,total,startTime){
  const pct = Math.floor(current/total*100);
  progressBar.style.width = pct+'%';
  progressBar.textContent = pct+'%';
  const elapsed = (Date.now() - startTime)/1000;
  const eta = elapsed/current*(total-current);
  etaEl.textContent = `進度: ${current}/${total}，預估剩餘 ${Math.ceil(eta)} 秒`;
}

$('startBtn').addEventListener('click', async ()=>{
  const fileInp = $('epubFile');
  if(!fileInp.files || !fileInp.files.length){ log('請選 EPUB'); return; }
  const file = fileInp.files[0];
  const profile = $('profile').value;

  const converter = profile==='s2twp'
    ? OpenCC.Converter({ from:'cn', to:'twp' })
    : OpenCC.Converter({ from:'cn', to:'twt' });

  log(`讀取 EPUB: ${file.name} ...`);
  const arrayBuffer = await file.arrayBuffer();
  const zip = await JSZip.loadAsync(arrayBuffer);

  // 解析 container.xml
  const containerXml = await zip.file('META-INF/container.xml').async('string');
  const parser = new DOMParser();
  const containerDoc = parser.parseFromString(containerXml,'application/xml');
  const rootfile = containerDoc.querySelector('rootfile');
  if(!rootfile){ log('container.xml 解析失敗'); return; }

  const opfPath = rootfile.getAttribute('full-path');
  const opfFolder = opfPath.includes('/') ? opfPath.substring(0, opfPath.lastIndexOf('/')) : '';

  const opfText = await zip.file(opfPath).async('string');
  const opfDoc = parser.parseFromString(opfText,'application/xml');

  const manifest = {};
  for(const item of opfDoc.querySelectorAll('manifest > item')){
    manifest[item.getAttribute('id')] = {
      href: item.getAttribute('href'),
      type: item.getAttribute('media-type')
    };
  }

  const spine = [...opfDoc.querySelectorAll('spine > itemref')]
    .map(ir=>ir.getAttribute('idref'));

  const htmlFiles = [];
  for(const idref of spine){
    const it = manifest[idref];
    if(!it) continue;
    if(it.type?.includes('xhtml') || it.type?.includes('html') || it.href.endsWith('.xhtml') || it.href.endsWith('.html')){
      htmlFiles.push(it.href);
    }
  }

  log(`找到 ${htmlFiles.length} 個章節`);

  const startTime = Date.now();
  for(let i=0;i<htmlFiles.length;i++){
    const href = htmlFiles[i];
    const resolved = opfFolder ? `${opfFolder}/${href}` : href;
    const fileEntry = zip.file(resolved) || zip.file(href);
    if(!fileEntry){ log(`找不到 ${resolved}`); continue; }

    log(`轉換章節 ${i+1}/${htmlFiles.length}: ${href}`);
    const html = await fileEntry.async('string');
    let converted = converter(html);

    // 可選：轉換引號（只處理文字節點）
    if($('convertQuotes').checked){
      const doc = parser.parseFromString(converted, 'application/xhtml+xml');

      function walk(node){
        if(node.nodeType === Node.TEXT_NODE){
          node.nodeValue = convertQuotes(node.nodeValue);
        } else if(node.nodeType === Node.ELEMENT_NODE){
          const tag = node.tagName?.toLowerCase();
          // 不處理 script / style
          if(tag === 'script' || tag === 'style') return;
          for(const c of node.childNodes) walk(c);
        }
      }

      walk(doc.documentElement);
      converted = new XMLSerializer().serializeToString(doc);
    }

    zip.file(resolved, converted);

    updateProgress(i+1, htmlFiles.length, startTime);
    await new Promise(r=>setTimeout(r,0)); // 讓 UI 有時間刷新
  }

  log('生成新 EPUB...');
  const newBlob = await zip.generateAsync({type:'blob', compression:'DEFLATE'});
  const downloadName = file.name.replace(/\.epub$/i,'') + ' (繁中).epub';
  const a = document.createElement('a');
  a.href = URL.createObjectURL(newBlob);
  a.download = downloadName;
  a.className = 'btn btn-success';
  a.textContent = '下載 ' + downloadName;

  const area = $('downloadArea');
  area.innerHTML = '';
  area.appendChild(a);
  log('完成！');
}

// 安全的引號轉換（僅作用於純文字）
function convertQuotes(text){
  let openDouble = true;
  let openSingle = true;

  return text
    .replace(/"/g, () => {
      const q = openDouble ? '「' : '」';
      openDouble = !openDouble;
      return q;
    })
    .replace(/'/g, () => {
      const q = openSingle ? '『' : '』';
      openSingle = !openSingle;
      return q;
    });
}
});
</script>
</body>
</html>
